<!-- HEAD unchanged, styles and Firebase config preserved -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frome Geek Gaming 40K Tables</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* (All your CSS styles unchanged) */
    /* ... */
  </style>
</head>
<body>
  <!-- (All your HTML unchanged) -->
  <!-- ... -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBFzGr19X4tIaBCU0SnISUzFSaZPQ5m1_k",
      authDomain: "fgg-table-booking.firebaseapp.com",
      databaseURL: "https://fgg-table-booking-default-rtdb.firebaseio.com",
      projectId: "fgg-table-booking",
      storageBucket: "fgg-table-booking.firebasestorage.app",
      messagingSenderId: "734963630039",
      appId: "1:734963630039:web:836fd3f994377ffd719592",
      measurementId: "G-PQ2V6KG6BE"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tunnelsTables = 6;
    const crownTables = 3;

    let currentDate = getTodayDate();
    let allBookings = {};
    let calendarMonth = new Date().getMonth();
    let calendarYear = new Date().getFullYear();
    let calendarBookings = {};

    const bookingDateInput = document.getElementById("bookingDate");
    bookingDateInput.value = currentDate;
    bookingDateInput.addEventListener("change", e => {
      currentDate = e.target.value;
      listenForBookings();
      highlightSelectedDay(currentDate);
    });

    function getTodayDate() {
      const today = new Date();
      return today.getFullYear() + "-" +
             String(today.getMonth() + 1).padStart(2, '0') + "-" +
             String(today.getDate()).padStart(2, '0');
    }

    function getDayName(dateStr) {
      return new Date(dateStr).toLocaleDateString("en-GB", { weekday: "long" });
    }

    function toggleBooking(area, tableIndex) {
      const nameInput = document.getElementById("playerName");
      const name = nameInput.value.trim();
      const tableKey = `${area}_table${tableIndex}`;
      const tableRef = db.ref(`bookings/${currentDate}/${tableKey}`);
      const isBooked = allBookings[tableKey];

      if (isBooked) {
        tableRef.remove();
      } else {
        if (!name) {
          alert("Please enter your name to book a table.");
          return;
        }
        tableRef.set(name);
      }
    }

    function listenForBookings() {
      db.ref(`bookings/${currentDate}`).on("value", snapshot => {
        allBookings = snapshot.val() || {};
        renderTables();
      });
    }

    function renderTables() {
      const container = document.getElementById("tablesContainer");
      container.innerHTML = "";

      const day = getDayName(currentDate);

      if (day === "Tuesday") {
        renderSection("The Tunnels", tunnelsTables, "tunnels", container);
      }

      if (day === "Monday") {
        renderSection("The Crown", crownTables, "crown", container);
      }

      if (day !== "Monday" && day !== "Tuesday") {
        container.innerHTML = `<p style="margin-top: 30px;">No tables available for booking on ${day}s.</p>`;
      }
    }

    function renderSection(title, count, area, container) {
      const section = document.createElement("div");
      section.className = "section-wrapper";
      section.innerHTML = `<h2 class="section-title">${title}</h2>`;
      const tableRow = document.createElement("div");
      tableRow.className = "tables";

      for (let i = 0; i < count; i++) {
        const tableKey = `${area}_table${i}`;
        const isBooked = allBookings[tableKey];
        const name = isBooked || "";

        const div = document.createElement("div");
        div.className = "table";
        const buttonClass = isBooked ? "unbook-btn" : "book-btn";
        const buttonLabel = isBooked ? "Unbook" : "Book Now";

        div.innerHTML = `
          <h3>Table ${i + 1}</h3>
          <p>Status: ${isBooked ? "Booked" : "Available"}</p>
          ${name ? `<div class="booked-by">Booked by: ${name}</div>` : ""}
          <button class="${buttonClass}" onclick="toggleBooking('${area}', ${i})">${buttonLabel}</button>
        `;
        tableRow.appendChild(div);
      }

      section.appendChild(tableRow);
      container.appendChild(section);
    }

    async function exportBookingsToExcel() {
      const range = document.getElementById("exportRange").value;
      const baseDate = new Date(document.getElementById("bookingDate").value);
      const dateList = [];

      for (let i = 0; i < (range === 'week' ? 7 : range === 'month' ? 31 : range === 'year' ? 366 : 1); i++) {
        const d = new Date(baseDate);
        d.setDate(d.getDate() + i);
        const dateStr = d.getFullYear() + "-" +
                        String(d.getMonth() + 1).padStart(2, '0') + "-" +
                        String(d.getDate()).padStart(2, '0');
        dateList.push(dateStr);
      }

      const bookingsSnapshot = await Promise.all(
        dateList.map(date => db.ref(`bookings/${date}`).get().then(snap => ({ date, data: snap.val() || {} })))
      );

      const rows = [["Date", "Area", "Table", "Booked By"]];
      bookingsSnapshot.forEach(({ date, data }) => {
        Object.entries(data).forEach(([key, value]) => {
          const [area, table] = key.split("_table");
          rows.push([date, area, `Table ${parseInt(table) + 1}`, value]);
        });
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Bookings");
      XLSX.writeFile(wb, `bookings_${range}_${getTodayDate()}.xlsx`);
    }

    async function generateCalendar() {
      const calendar = document.getElementById("calendar");
      const label = document.getElementById("calendarMonthLabel");
      calendar.innerHTML = "";

      const firstDate = new Date(calendarYear, calendarMonth, 1);
      const firstWeekday = (firstDate.getDay() + 6) % 7;
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();

      const monthName = new Date(calendarYear, calendarMonth).toLocaleString("en-GB", {
        month: "long",
        year: "numeric"
      });
      label.textContent = monthName;

      const monthDates = [];
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(calendarYear, calendarMonth, d);
        const dateStr = date.getFullYear() + "-" +
                        String(date.getMonth() + 1).padStart(2, '0') + "-" +
                        String(date.getDate()).padStart(2, '0');
        monthDates.push(dateStr);
      }

      const snapArray = await Promise.all(
        monthDates.map(date =>
          db.ref(`bookings/${date}`).get().then(snap => ({ date, data: snap.val() || {} }))
        )
      );

      calendarBookings = {};
      snapArray.forEach(({ date, data }) => {
        calendarBookings[date] = data;
      });

      for (let i = 0; i < firstWeekday; i++) {
        calendar.appendChild(document.createElement("div"));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(calendarYear, calendarMonth, day);
        const dateStr = date.getFullYear() + "-" +
                        String(date.getMonth() + 1).padStart(2, '0') + "-" +
                        String(date.getDate()).padStart(2, '0');
        const bookings = calendarBookings[dateStr] || {};
        const dayName = date.toLocaleDateString("en-GB", { weekday: "long" });

        let totalTables = 0;
        let validKeys = [];

        if (dayName === "Monday") {
          totalTables = crownTables;
          validKeys = Array.from({ length: crownTables }, (_, i) => `crown_table${i}`);
        } else if (dayName === "Tuesday") {
          totalTables = tunnelsTables;
          validKeys = Array.from({ length: tunnelsTables }, (_, i) => `tunnels_table${i}`);
        }

        const bookedCount = validKeys.filter(key => bookings[key]).length;

        const div = document.createElement("div");
        div.className = "calendar-day";
        div.dataset.date = dateStr;

        if (totalTables === 0) div.classList.add("available");
        else if (bookedCount === 0) div.classList.add("available");
        else if (bookedCount >= totalTables) div.classList.add("full");
        else div.classList.add("partial");

        div.textContent = day;

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.textContent = totalTables > 0 ? `${bookedCount}/${totalTables}` : "â€”";
        div.appendChild(summary);

        if (dateStr === getTodayDate()) div.classList.add("today");
        if (dateStr === bookingDateInput.value) div.classList.add("selected");

        div.addEventListener("click", () => {
          bookingDateInput.value = dateStr;
          currentDate = dateStr;
          listenForBookings();
          highlightSelectedDay(dateStr);
        });

        calendar.appendChild(div);
      }
    }

    function highlightSelectedDay(dateStr) {
      document.querySelectorAll(".calendar-day").forEach(el => {
        el.classList.remove("selected");
        if (el.dataset.date === dateStr) {
          el.classList.add("selected");
        }
      });
    }

    function changeMonth(offset) {
      calendarMonth += offset;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      } else if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      generateCalendar();
    }

    listenForBookings();
    generateCalendar();
  </script>
</body>
</html>
