<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frome Geek Gaming 40K Tables</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1a1a1a;
      color: #f0f0f0;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #00ff99; margin-bottom: 10px; }
    h2.section-title { margin-top: 40px; font-size: 24px; color: #00ccff; }
    .tables { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
    .table { background-color: #333; border: 2px solid #00ff99; padding: 20px; width: 200px; border-radius: 10px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .book-btn { background-color: #00ff99; color: #000; }
    .unbook-btn { background-color: #ff4d4d; color: #fff; }
    input[type="date"], input[type="text"], select {
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #00ff99;
      background-color: #1a1a1a;
      color: #f0f0f0;
      width: 220px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .booked-by { font-size: 0.9em; color: #bbb; margin-top: 5px; }
    .section-wrapper { margin-top: 30px; }
  </style>
</head>
<body>

  <h1>Frome Geek Gaming 40K Tables</h1>
  <input type="date" id="bookingDate" />
  <input type="text" id="playerName" placeholder="Enter your name" />

  <select id="exportRange">
    <option value="day">Current Day</option>
    <option value="week">Current Week</option>
    <option value="month">Current Month</option>
    <option value="year">Current Year</option>
  </select>
  <button onclick="downloadBookingsRange()">Download Excel</button>

  <div id="tablesContainer"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBFzGr19X4tIaBCU0SnISUzFSaZPQ5m1_k",
      authDomain: "fgg-table-booking.firebaseapp.com",
      databaseURL: "https://fgg-table-booking-default-rtdb.firebaseio.com",
      projectId: "fgg-table-booking",
      storageBucket: "fgg-table-booking.appspot.com",
      messagingSenderId: "734963630039",
      appId: "1:734963630039:web:836fd3f994377ffd719592"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tunnelsTables = 6;
    const crownTables = 3;

    let currentDate = getTodayDate();
    let allBookings = {};

    const bookingDateInput = document.getElementById("bookingDate");
    bookingDateInput.value = currentDate;
    bookingDateInput.addEventListener("change", e => {
      currentDate = e.target.value;
      listenForBookings();
    });

    function getTodayDate() {
      return new Date().toISOString().split("T")[0];
    }

    function getDayName(dateStr) {
      return new Date(dateStr).toLocaleDateString("en-GB", { weekday: "long" });
    }

    function toggleBooking(area, tableIndex) {
      const name = document.getElementById("playerName").value.trim();
      const tableKey = `${area}_table${tableIndex}`;
      const tableRef = db.ref(`bookings/${currentDate}/${tableKey}`);
      const isBooked = allBookings[tableKey];

      if (isBooked) {
        tableRef.remove();
      } else {
        if (!name) {
          alert("Please enter your name to book a table.");
          return;
        }
        tableRef.set(name);
      }
    }

    function listenForBookings() {
      db.ref(`bookings/${currentDate}`).on("value", snapshot => {
        allBookings = snapshot.val() || {};
        renderTables();
      });
    }

    function renderTables() {
      const container = document.getElementById("tablesContainer");
      container.innerHTML = "";

      const day = getDayName(currentDate);

      if (day === "Tuesday") renderSection("The Tunnels", tunnelsTables, "tunnels", container);
      if (day === "Monday") renderSection("The Crown", crownTables, "crown", container);

      if (day !== "Monday" && day !== "Tuesday") {
        container.innerHTML = `<p style="margin-top: 30px;">No tables available for booking on ${day}s.</p>`;
      }
    }

    function renderSection(title, count, area, container) {
      const section = document.createElement("div");
      section.className = "section-wrapper";
      section.innerHTML = `<h2 class="section-title">${title}</h2>`;
      const tableRow = document.createElement("div");
      tableRow.className = "tables";

      for (let i = 0; i < count; i++) {
        const tableKey = `${area}_table${i}`;
        const isBooked = allBookings[tableKey];
        const name = isBooked || "";
        const div = document.createElement("div");
        div.className = "table";
        const buttonClass = isBooked ? "unbook-btn" : "book-btn";
        const buttonLabel = isBooked ? "Unbook" : "Book Now";

        div.innerHTML = `
          <h3>Table ${i + 1}</h3>
          <p>Status: ${isBooked ? "Booked" : "Available"}</p>
          ${name ? `<div class="booked-by">Booked by: ${name}</div>` : ""}
          <button class="${buttonClass}" onclick="toggleBooking('${area}', ${i})">${buttonLabel}</button>
        `;
        tableRow.appendChild(div);
      }

      section.appendChild(tableRow);
      container.appendChild(section);
    }

    async function downloadBookingsRange() {
      const range = document.getElementById("exportRange").value;
      const selectedDate = new Date(currentDate);
      const dates = [];

      if (range === "day") {
        dates.push(currentDate);
      } else if (range === "week") {
        const dayIndex = selectedDate.getDay();
        const monday = new Date(selectedDate);
        monday.setDate(selectedDate.getDate() - ((dayIndex + 6) % 7));
        for (let i = 0; i < 7; i++) {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          dates.push(d.toISOString().split("T")[0]);
        }
      } else if (range === "month") {
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
          const d = new Date(year, month, i);
          dates.push(d.toISOString().split("T")[0]);
        }
      } else if (range === "year") {
        const year = selectedDate.getFullYear();
        for (let month = 0; month < 12; month++) {
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          for (let i = 1; i <= daysInMonth; i++) {
            const d = new Date(year, month, i);
            dates.push(d.toISOString().split("T")[0]);
          }
        }
      }

      const rows = [];

      for (const dateStr of dates) {
        const snapshot = await firebase.database().ref(`bookings/${dateStr}`).get();
        const data = snapshot.val();
        if (data) {
          for (const key in data) {
            const [area, table] = key.split("_table");
            const tableNumber = parseInt(table) + 1;
            const bookedBy = data[key];
            rows.push({ Date: dateStr, Area: area.charAt(0).toUpperCase() + area.slice(1), Table: tableNumber, "Booked By": bookedBy });
          }
        }
      }

      if (rows.length === 0) {
        alert("No bookings found in selected range.");
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Bookings");
      XLSX.writeFile(workbook, `bookings_${range}_${currentDate}.xlsx`);
    }

    listenForBookings();
  </script>

</body>
</html>
